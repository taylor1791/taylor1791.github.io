<!DOCTYPE html>
<html>
  <head>
<style>
    #monstersCaught {
      font-size:45px;
    }
    .canvasWrap {
      width:100%;
      float:left;
      margin:0 auto;
      text-align:center;
    }
    #myCanvas {
      border:1px solid gray;
      margin:0 auto;

    }
    #high_scores {
      padding:30px;
      margin:0 auto;
    }
    #high_scores tr{
      height:30px;
    }
    #high_scores td{
      padding:3px;
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.7.1/dist/jquery.min.js"></script>
  <script type="text/javascript">
    var mainInterval, then;
    var gameIsStarted = false;

    $(document).ready(function() {
      var $player = $('#player'),
          $timeRemaining = $('#time-remaining'),
          timeOut;

      $(".volume").bind('click', function() {
        changeVolume(parseFloat($(this).attr('value')));
      });

      $player.bind('playing', function() {
        if (!gameIsStarted) {
          $timeRemaining.html(Math.floor($player.get()[0].duration))
        }
      }).bind('timeupdate', function() {
        var elem = $player.get()[0];
        $timeRemaining.html(displaySeconds(Math.floor(elem.duration - elem.currentTime)));
      }).bind('ended', function() {
        submitScore($('#monstersCaught').html());
        clearInterval(window.mainInterval);
        gameIsStarted = false;
      });

      $('#start').click(startGame);
      $('#pause').click(pauseGame);
      setupCanvas();
      reset(true);
      console.log("calling render");
      render();
    });

    function submitScore(score){
      // $.ajax({
      //   type: 'POST',
      //   url: '/game/<%= @game_id %>',
      //   data: {"id": <%= @game_id %>, "score":score},
      //   success: function(data,status,xhr){
      //     $("#high_scores").html(data.high_scores);
      //   }
      // });
    }

    function changeVolume(change) {
      var player = document.getElementById('player');
      player.volume += change;
      if (change == 0) {
        player.volume = 0;
        $("#volume").text(0)
      } else {
        $("#volume").text(parseInt((player.volume + 0.1) * 10))
      }
    }

    function startGame() {
      if (!gameIsStarted) {
        reset(true);
        window.then = Date.now();
        $('#monstersCaught').html('0');
        monstersCaught = 0;
        bgImage.src = "assets/game_background_1.png";
        gameIsStarted = true;
      }
      window.mainInterval = setInterval(main, 1);
      $('#player').get()[0].play();
    }

    function pauseGame() {
      clearInterval(window.mainInterval);
      $('#player').get()[0].pause();
    }

    function displaySeconds(seconds) {
      var minuteString = (seconds > 60) ? seconds / 60 : "00",
          secondString = (seconds % 60) + "";
      if (secondString.length === 1) { secondString = "0" + secondString; }
      return minuteString + ":" + secondString;
    }
  </script>
  <body>
    <div class="canvasWrap">
      <button id='start'>Start Game</button>
      <button id='pause'>Pause Game</button>
      <button class="volume" value="0.1">Volume Up</button>
      <button class="volume" value="-0.1">Volume Down</button>
      <button class="volume" value="0">Mute</button>
      Volume: <span id="volume">10</span>
    </div>
    <div class="canvasWrap">
      <h1>Super Awesome Awesome Game</h1>
      <h4>Time Remaining: <span id='time-remaining'>Derp</span></h3>
    <canvas id="myCanvas"></canvas>
      <h3>Tags Found:</h3>
      <span id="monstersCaught">0</span>
  </div>
    <div id="monsterContainer">
    </div>
    <audio id="player" src="goeswithanything.ogg"></audio>

    <div class="canvasWrap">
    <div id="high_scores">High Scores not Implemented</div>
      <!-- <%= render partial: "high_scores", locals: {scores: @top_ten}%> -->
  </div>

  <script>
// Create the canvas
var canvas = document.getElementById("myCanvas");
var ctx = canvas.getContext("2d");

var bgImage = new Image();
var heroImage = new Image();
var monsterImage = new Image();

var bgReady = false;
var heroReady = false;
var monsterReady = false;

// Background image
bgImage.onload = function () {
	console.log("loaded");
	bgReady = true;
	ctx.drawImage(bgImage, 0, 0);

};
bgImage.src = "assets/game_background.png";

// Hero image
heroImage.onload = function () {
	heroReady = true;
};
heroImage.src = "assets/robot-4040.png";

// Monster image
monsterImage.onload = function () {
	monsterReady = true;
};
monsterImage.src = "assets/tag-4040.png";




// Game objects
var hero = {
	speed: 256 // movement in pixels per second
};
var monster = {};
var monstersCaught = 0;

// Handle keyboard controls
var keysDown = {};

function setupCanvas() {
	canvas.width = 512;
	canvas.height = 480;
	canvas.tabIndex = 1;
	canvas.focus();


	addEventListener("keydown", function (e) {
		keysDown[e.keyCode] = true;
		if (e.keyCode == 37 || e.keyCode == 38 || e.keyCode == 39 || e.keyCode == 40) {
			e.preventDefault();
		}
	}, false);

	addEventListener("keyup", function (e) {
		delete keysDown[e.keyCode];
		if (e.keyCode == 37 || e.keyCode == 38 || e.keyCode == 39 || e.keyCode == 40) {
			e.preventDefault();
		}

	}, false);
}
// Reset the game when the player catches a monster
var reset = function (setHero) {
	if (setHero) {
		hero.x = canvas.width / 2;
		hero.y = canvas.height / 2;
	}

	// Throw the monster somewhere on the screen randomly
	monster.x = 32 + (Math.random() * (canvas.width - 64));
	monster.y = 32 + (Math.random() * (canvas.height - 64));
};

// Update game objects
var update = function (modifier) {
	if (38 in keysDown) { // Player holding up
		hero.y -= hero.speed * modifier;
	}
	if (40 in keysDown) { // Player holding down
		hero.y += hero.speed * modifier;
	}
	if (37 in keysDown) { // Player holding left
		hero.x -= hero.speed * modifier;
	}
	if (39 in keysDown) { // Player holding right
		hero.x += hero.speed * modifier;
	}

	// Wrap x value
	if (hero.x > canvas.width) {
		hero.x -= canvas.width;
	} else if (hero.x < 0) {
		hero.x += canvas.width;
	}

	// Wrap y value
	if (hero.y > canvas.height) {
		hero.y -= canvas.height;
	} else if (hero.y < 0) {
		hero.y += canvas.height;
	}

	// Are they touching?
	if (
		hero.x <= (monster.x + 32)
		&& monster.x <= (hero.x + 32)
		&& hero.y <= (monster.y + 32)
		&& monster.y <= (hero.y + 32)
	) {
		++monstersCaught;

    var monsterCaughtElement = document.getElementById('monstersCaught');
    monsterCaughtElement.innerHTML = monstersCaught;


	if (Math.round(Math.random()) == 1) {
	    var randomNum = Math.floor(Math.random() * 5) + 1;
	    bgImage.src = "assets/game_background_" + randomNum + ".png";
	}


		reset(false);
	}
};

// Draw everything
var render = function () {
	if (bgReady) {
		ctx.drawImage(bgImage, 0, 0);
	}

	if (heroReady) {
		ctx.drawImage(heroImage, hero.x, hero.y);
	}

	if (monsterReady) {
		ctx.drawImage(monsterImage, monster.x, monster.y);
	}
};

// The main game loop
var main = function () {
	var now = Date.now();
	var delta = now - then;

	update(delta / 1000);
	render();

	then = now;
};
    </script>

  </body>
  </html
